#!/bin/bash

set -e

if [[ ${#} -ne 1 ]]; then
	echo "Usage: ${0} <version>"
	exit 1
fi

version="${1}"

docker build -t admin-services-docusaurus -f ./docker/Dockerfile .

aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 077020411687.dkr.ecr.us-west-2.amazonaws.com

docker tag admin-services-docusaurus:latest \
	"077020411687.dkr.ecr.us-west-2.amazonaws.com/admin-services-docusaurus:latest"
docker tag admin-services-docusaurus:latest \
	"077020411687.dkr.ecr.us-west-2.amazonaws.com/admin-services-docusaurus:${version}"

docker push "077020411687.dkr.ecr.us-west-2.amazonaws.com/admin-services-docusaurus:latest"
docker push "077020411687.dkr.ecr.us-west-2.amazonaws.com/admin-services-docusaurus:${version}"

aws ecs update-service \
	--cluster Admin-Services-Docusaurus \
	--service Admin-Services-Docusaurus \
	--force-new-deployment

echo "Waiting for service to stabilize ..."
aws ecs wait services-stable \
	--cluster Admin-Services-Docusaurus \
	--service Admin-Services-Docusaurus

echo Done
